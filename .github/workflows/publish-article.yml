name: Publish Article

on:
  # Run daily at 9 AM UTC
  schedule:
    - cron: '0 9,18 * * *'   # Twice daily
  
  # Allow manual trigger with optional inputs
  workflow_dispatch:
    inputs:
      voice_tone:
        description: 'Writing tone'
        required: false
        default: 'conversational'
        type: choice
        options:
          - conversational
          - professional
          - casual
          - authoritative
      dry_run:
        description: 'Dry run (do not publish)'
        required: false
        default: false
        type: boolean

env:
  NODE_VERSION: '20'

jobs:
  generate-and-publish:
    name: Generate & Publish Article
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build TypeScript
        run: npm run build

      - name: Run article pipeline
        env:
          # OpenAI Configuration
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_MODEL: ${{ vars.OPENAI_MODEL || 'gpt-4o' }}
          
          # WordPress Configuration
          WP_URL: ${{ secrets.WP_URL }}
          WP_USERNAME: ${{ secrets.WP_USERNAME }}
          WP_APP_PASSWORD: ${{ secrets.WP_APP_PASSWORD }}
          WP_CATEGORY: ${{ vars.WP_CATEGORY || 'Uncategorized' }}
          
          # Google Trends Configuration
          TRENDS_GEO: ${{ vars.TRENDS_GEO || 'US' }}
          TRENDS_CATEGORY: ${{ vars.TRENDS_CATEGORY || 'all' }}
          
          # Voice Configuration
          VOICE_TONE: ${{ inputs.voice_tone || vars.VOICE_TONE || 'conversational' }}
          VOICE_PERSPECTIVE: ${{ vars.VOICE_PERSPECTIVE || 'second_person' }}
          VOICE_PERSONALITY: ${{ vars.VOICE_PERSONALITY || 'friendly expert who uses analogies and real-world examples' }}
          
          # Unsplash Configuration (for featured images)
          UNSPLASH_ACCESS_KEY: ${{ secrets.UNSPLASH_ACCESS_KEY }}
          UNSPLASH_ENABLED: ${{ vars.UNSPLASH_ENABLED || 'true' }}
          
          # Logging
          LOG_LEVEL: info
        run: |
          if [ "${{ inputs.dry_run }}" == "true" ]; then
            echo "DRY RUN MODE - Would run: npm start"
            echo "Configuration:"
            echo "  Model: $OPENAI_MODEL"
            echo "  WordPress URL: $WP_URL"
            echo "  Category: $WP_CATEGORY"
            echo "  Trends Geo: $TRENDS_GEO"
            echo "  Voice Tone: $VOICE_TONE"
          else
            npm start
          fi

      - name: Persist topic cluster data
        if: success() && inputs.dry_run != 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          if git diff --quiet data/topic-clusters.json; then
            echo "No cluster data changes to commit"
          else
            git add data/topic-clusters.json
            git commit -m "chore: update topic cluster data [skip ci]"
            git push
          fi

      - name: Upload logs artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pipeline-logs-${{ github.run_id }}
          path: |
            *.log
          retention-days: 7
          if-no-files-found: ignore

  notify-on-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: generate-and-publish
    if: failure()
    
    steps:
      - name: Send failure notification
        run: |
          echo "Article generation pipeline failed!"
          echo "Run ID: ${{ github.run_id }}"
          echo "Check the logs at: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          # Add your notification logic here (Slack, email, etc.)
          # Example for Slack:
          # curl -X POST -H 'Content-type: application/json' \
          #   --data '{"text":"Article pipeline failed! Check: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"}' \
          #   ${{ secrets.SLACK_WEBHOOK_URL }}
